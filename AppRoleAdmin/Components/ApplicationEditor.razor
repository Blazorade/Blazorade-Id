@using Microsoft.Graph.Models
@inject GraphClientService GraphClient

<AppRoleEditorDrawer AppRole="this.EditedAppRole" IsOpen="this.IsAppRoleEditorOpen" />

@if(null != this.Application)
{
    <MudPaper Elevation="0" Class="pa-2 mb-8 mt-4">
        <MudText Typo="Typo.h4">@this.Application.DisplayName</MudText>
        <MudText Typo="Typo.subtitle1"><b>Object Id:</b> @this.Application.Id</MudText>
        <MudText Typo="Typo.subtitle1"><b>Client Id:</b> @this.Application.AppId</MudText>
        @if (null != this.AppServicePrincipal)
        {
            <MudText Typo="Typo.subtitle1"><b>Service Principal Id:</b> @this.AppServicePrincipal.Id</MudText>
        }
    </MudPaper>

    <MudStack Row="true" AlignItems="AlignItems.Start">
        <div>
            <MudText Typo="Typo.h5">App Roles</MudText>
            <MudList T="AppRole" SelectionMode="SelectionMode.SingleSelection" @bind-SelectedValue="this.SelectedAppRole" @bind-SelectedValue:after="() => { this.EditedAppRole = this.SelectedAppRole; }" >
                @foreach (var role in this.Application.AppRoles ?? [])
                {
                    <MudListItem Value="role">
                        <MudText Typo="Typo.h6">@role.Value</MudText>
                        <MudText Typo="Typo.caption">App Role Id: @role.Id</MudText>
                        <MudText Typo="Typo.subtitle1">@role.DisplayName</MudText>
                        <MudText Typo="Typo.body2">@role.Description</MudText>
                    </MudListItem>
                }
            </MudList>

            <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined" Class="mt-4">
                <MudButton Disabled="null == this.SelectedAppRole" OnClick="() => { this.IsAppRoleEditorOpen = true; }">Edit</MudButton>
                <MudButton OnClick="() => { this.EditedAppRole = this.GetNewAppRole(); this.IsAppRoleEditorOpen = true; }">Add App Role</MudButton>
            </MudButtonGroup>
        </div>
        <div>
            <MudText Typo="Typo.h5">Assigned Principals</MudText>
            @if (this.Assignments?.Count > 0)
            {
                <MudList T="AppRoleAssignment">
                    @foreach (var assignment in this.Assignments)
                    {
                        <MudListItem Value="assignment">
                            <MudText Typo="Typo.h6">@assignment.PrincipalType: @assignment.PrincipalDisplayName</MudText>
                            <MudText Typo="Typo.caption">Principal Id: @assignment.PrincipalId</MudText>
                        </MudListItem>
                    }
                </MudList>
            }
        </div>
    </MudStack>
}


@code {
    [Parameter]
    public Application? Application { get; set; }

    private ServicePrincipal? AppServicePrincipal;

    private List<AppRoleAssignment>? Assignments;

    private AppRole? EditedAppRole;
    private AppRole? SelectedAppRole;

    private bool IsAppRoleEditorOpen;

    protected async override Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        this.Assignments = new List<AppRoleAssignment>();

        if(null != this.Application)
        {
            this.AppServicePrincipal = await this.GraphClient.GetServicePrincipalAsync(this.Application);
        }
    }

    private async Task OnSelectedAppRoleChangedAsync()
    {
        Console.WriteLine($"Selected app role: {this.SelectedAppRole?.Value}");

        this.Assignments = new List<AppRoleAssignment>();
        if (null != this.AppServicePrincipal && null != this.SelectedAppRole)
        {
            Console.WriteLine("Getting app role assignments...");

            var assignments = this.GraphClient.GetAppRoleAssignmentsAsync(this.AppServicePrincipal, this.SelectedAppRole);
            await foreach (var assignment in assignments)
            {
                this.Assignments.Add(assignment);
            }
        }
    }

    private AppRole GetNewAppRole()
    {
        return new AppRole
        {
            Value = "Resource.Action.Constraint"
        };
    }

}