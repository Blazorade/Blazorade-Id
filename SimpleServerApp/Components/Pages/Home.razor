
@page "/"
@inject ITokenService TokenService
@inject ILocalStorageService LocalStore

<PageTitle>Blazorade Id Sample Server App</PageTitle>

<h1>Get Tokens</h1>

<div>
    <label for="scopesField">Scopes</label>
    <InputText @bind-Value="this.Scopes" DisplayName="Scopes" id="scopesField" />
</div>
<div style="margin-top: 1em;">
    <label for="promptField">Prompt</label>
    <InputSelect TValue="Prompt?" @bind-Value="this.Prompt" id="promptField">
        <option value="">Not Specified</option>
        <option value="None">None</option>
        <option value="Login">Login</option>
        <option value="Consent">Consent</option>
        <option value="Select_Account">Select Account</option>
    </InputSelect>
</div>
<div style="margin-top: 1em;">

</div>
<button type="submit" @onclick="this.OnGetTokensAsync">Get Tokens</button>

@if(this.AccessTokens.Count > 0)
{
    <h2>Access Tokens</h2>
    @foreach(var item in this.AccessTokens)
    {
        <h3>Resource: @item.Key</h3>
        <p>
            <a href="https://jwt.ms/#access_token=@item.Value.RawData" target="_blank">@item.Value.RawData</a>
        </p>
    }
}

@if(this.IdToken?.Length > 0)
{
    <h2>ID Token</h2>
    <p>
        <a href="https://jwt.ms/#id_token=@this.IdToken" target="_blank">@this.IdToken</a>
    </p>
}

@code {
    private const string DefaultScopes = "openid profile email";
    private string? Scopes;
    private AccessTokenDictionary AccessTokens = new AccessTokenDictionary();
    private string? IdToken;
    private Prompt? Prompt;

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if(firstRender)
        {
            this.Scopes = await this.LocalStore.GetItemAsync<string?>("scopes") ?? DefaultScopes;
            this.StateHasChanged();
        }
    }

    private async Task OnGetTokensAsync(MouseEventArgs args)
    {
        this.AccessTokens.Clear();
        this.IdToken = null;

        await this.LocalStore.SetItemAsync("scopes", this.Scopes);

        var getOptions = new GetTokenOptions
            {
                Prompt = this.Prompt,
                Scopes = $"{this.Scopes}".Split(' ', StringSplitOptions.RemoveEmptyEntries)
            };

        this.AccessTokens = await this.TokenService.GetAccessTokensAsync(getOptions);

        var idTokenJwt = await this.TokenService.GetIdentityTokenAsync(new GetTokenOptions { Scopes = getOptions.Scopes });
        this.IdToken = idTokenJwt?.RawData;

    }
}